{% extends "base.html" %}
{% load static %}
{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/reset.css">
<link rel="stylesheet" href="{% static 'css/style-pth.css' %}">
{% endblock %}
{% block content %}
        <div class="option">
            <form class="form-top" onsubmit="searchPlaces(); return false;">
                    <input type="text" value=" " id="keyword" size="15"> 
                    <button type="submit" class="search-button">Í≤ÄÏÉâ</button>
                    <i id="location-btn" class="ri-crosshair-2-line" style="font-size: 20px;
                    margin-left: 3px;
                    top: 2px;
                    position: relative;
                    cursor: pointer;"></i>
            </form>
        </div>
        <div class="map_wrap">
            <div id="map"></div>
            <div id="menu_wrap" class="bg_white">
                <hr>
                <ul id="placesList"></ul>
                <div id="pagination"></div>
            </div>
            <div class="bottom-btn"> 
                <button id="list-btn" class="list-button" onclick="toggleParkingList()">Ï£ºÏ∞®Ïû• Î¶¨Ïä§Ìä∏</button>
            </div>
            <div id="parkingListWrap" style="display: none;">
                <div class="sort-btn">
                    <div>
                        <i id="delete-btn" class="ri-close-large-line"></i>
                        <label for="hours">Ï£ºÏ∞®Ìï† ÏãúÍ∞Ñ:</label>
                        <input type="number" id="hours"  min="0"> ÏãúÍ∞Ñ
                        <input type="number" id="minutes" min="0" max="59"> Î∂Ñ
                        <button class="adjust" onclick="calculateAndSortParkingFees()">Ï†ÅÏö©</button>
                    </div>
                    <div class="list-way">
                        <button onclick="calculateAndSortParkingFees()">ÏöîÍ∏àÏàú</button>
                        <p> „Ö£ </p>
                        <button onclick="showClosestParkingLots()">Í±∞Î¶¨Ïàú</button>
                        <p> „Ö£ </p>
                        <button onclick="showRatingParkingLots()">Î≥ÑÏ†êÏàú</button>
                    </div>
                </div>
                <ul id="parkingList"></ul>
            </div>
            <div id="parkingDetailWrap" style="display: none;">
                <span id="parkingInfo-star"></span>
                <span id="parkingInfo-distance"></span>
                <i id="return-btn"class="ri-arrow-go-back-line"></i>
                <i id="delete-btn2" class="ri-close-large-line"></i>
                <div class="firstline">
                    <span id="parkingTitle"></span>
                    <i id="toggle-btn" onclick="toggleLike()" class="ri-heart-3-line"></i>
                    <span id="parkingInfo1"></span>
                </div>
                <span id="parkingInfo2"></span>
                <span id="parkingInfo3"></span>
                <span id="parkingInfo4"></span>
                <span id="parkingInfo5"></span>
                <span id="parkingInfo6"></span>
                <span id="parkingInfo7"></span>
                <span id="parkingInfo8"></span>
                <p id="parkingReview">Î¶¨Î∑∞
                    <i id="toggle-btn" onclick="toggleReview()" class="ri-arrow-down-s-fill"></i>
                </p>
                <div id="review" class="review">
                    <div class="star-rating">
                        <i class="ri-star-line" data-value="1"></i>
                        <i class="ri-star-line" data-value="2"></i>
                        <i class="ri-star-line" data-value="3"></i>
                        <i class="ri-star-line" data-value="4"></i>
                        <i class="ri-star-line" data-value="5"></i>
                    </div>
                    <p id="rating-display">0Ï†ê</p>
                    <textarea id="contentInput" placeholder="Î¶¨Î∑∞Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    <button class="review-btn" onclick="addReview()">Î¶¨Î∑∞ Îì±Î°ù</button>
                    <div class="review-list">
                    </div>
                </div>
                {% comment %}
                <p id="parkingCommunity">Ïª§ÎÆ§ÎãàÌã∞
                    <i id="toggle-btn2" onclick="toggleCommunity()" class="ri-arrow-down-s-fill"></i>
                </p>
                <div id="community" class="community">
                    <div class="messages">
                    </div>
                    <div class="input-msg">
                        <input id="messageInput" type="text" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
                        <button class="community-btn" onclick="sendMessage()">Ï†ÑÏÜ°</button>
                    </div>
                {% endcomment %}
                </div>
            </div>
        </div>
        {% endblock %}

        {% block scripts %}

        {% if parking_data %}
        {{ parking_data | json_script:'jsonData' }}
        {% endif %}
        <script>
            document.getElementById('keyword').value = localStorage.getItem('search_txt') || '';
        </script>
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{MAP_KEY}}&libraries=services"></script>
        <script>
            var markers = [];
            var parkingData = [];
            var selectedPlace = null;
            let debounceTimeout = null;
            let selectedParkingLotId = null;
            let selectedPlaceMarker = null;
            var visibleparkinglot = [];
            var parkingTime = null;
            let selectedRating = 0;
            const currentUser = "{{ user.username }}";
            let favoriteParkingIds = [];

            var mapContainer = document.getElementById('map'), 
                mapOption = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567), 
                    level: 3 
                };

            var map = new kakao.maps.Map(mapContainer, mapOption); 

            var ps = new kakao.maps.services.Places(); 

            var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 }); 
            var openInfoWindows = [];
            let allPlaces = [];

            if (!window.location.search.includes("parking_id=")){
                        searchPlaces(); 
                    } 
            loadParkingData();

            async function loadUserFavorites() {
                try {
                    const response = await fetch('/api/favorites/');
                    if (response.status === 403) {
                        alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.");
                        return;
                    }

                    if (!response.ok) throw new Error("Ï∞úÌïú Ï£ºÏ∞®Ïû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
                    
                    const data = await response.json();

                    favoriteParkingIds = data.liked_parking_lots.map(lot => lot.id);
                    if (selectedPlace) {
                        updateVisibleParkingMarkers();
                    } 
                } catch (error) {
                    console.error("üö® Ï∞úÌïú Ï£ºÏ∞®Ïû• Î°úÎìú Ïã§Ìå®:", error);
                }
            }


            // ÌéòÏù¥ÏßÄÍ∞Ä Î°úÎìúÎê† Îïå Ï∞úÌïú Ï£ºÏ∞®Ïû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Í∏∞
            document.addEventListener("DOMContentLoaded", loadUserFavorites);

            function searchPlaces() {
                allPlaces = [];
                selectedPlace = null;
                var keyword = document.getElementById('keyword').value;

                 // mypageÏïà favorite, myreview ÏóêÏÑú ÌÅ¥Î¶≠ Ïãú alert Î¨∏ ÏÉùÏÑ± Î∞©ÏßÄ
                if (!window.location.search.includes("parking_id=")) {
                if(!keyword.replace(/^\s+|\s+$/g, '')) {
                    alert('Ï£ºÏÜåÎÇò Ïû•ÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                    return false;
                }
                }
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, "", newUrl);

                ps.keywordSearch(keyword, placesSearchCB); 
            }
            
            function sortPlacesByDistance(userLatLng, places) {
                // Ïû•ÏÜå Î™©Î°ùÏóê Í∞Å Ïû•ÏÜåÍπåÏßÄÏùò Í±∞Î¶¨ Ï∂îÍ∞Ä
                var sortedPlaces = places.map(place => {
                    var placeLatLng = new kakao.maps.LatLng(place.y, place.x);
                    var distance = getDistance(userLatLng, placeLatLng);
                    return { ...place, distance };
                });
                // Í±∞Î¶¨ Í∏∞Ï§ÄÏúºÎ°ú Ïò§Î¶ÑÏ∞®Ïàú Ï†ïÎ†¨
                sortedPlaces.sort((a, b) => a.distance - b.distance);

                return sortedPlaces;
            }

            function placesSearchCB(data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                    if (selectedPlaceMarker) {
                        selectedPlaceMarker.setMap(null);
                        selectedPlaceMarker = null;
                    }
                    var menuEl = document.getElementById('menu_wrap');
                    menuEl.style.display = 'block';
                    closeAllInfoWindows();
                    document.getElementById('parkingListWrap').style.display = "none";
                    document.getElementById('list-btn').style.display = "block";
                    document.getElementById('parkingDetailWrap').style.display = "none";
                    // üî• Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏßëÌïòÏó¨ Ï†ÄÏû•
                    allPlaces = allPlaces.concat(data);

                    
                    if (pagination.current === pagination.last) {
                        processAndDisplayAllPlaces();
                    } else {
                        pagination.gotoPage(pagination.current + 1);
                    }

                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                    return;
                } else if (status === kakao.maps.services.Status.ERROR) {
                    alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    return;
                }
            }
            // Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Í±∞Î¶¨ÏàúÏúºÎ°ú Ï†ïÎ†¨ ÌõÑ, ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Ï†ÅÏö©
            function processAndDisplayAllPlaces() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var userLatLng = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        
                        allPlaces.sort((a, b) => {
                            var distA = getDistance(userLatLng, new kakao.maps.LatLng(a.y, a.x));
                            var distB = getDistance(userLatLng, new kakao.maps.LatLng(b.y, b.x));
                            return distA - distB;
                        });

                        applyCustomPagination(allPlaces);
                    }, function (error) {
                        console.error("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.", error);
                    });
                }
            }

            function applyCustomPagination(sortedPlaces) {
                let perPage = 15;
                let totalPage = Math.ceil(sortedPlaces.length / perPage);
                let paginationEl = document.getElementById('pagination');

                paginationEl.innerHTML = "";

                for (let i = 1; i <= totalPage; i++) {
                    let el = document.createElement('a');
                    el.href = "#";
                    el.innerHTML = i;

                    el.onclick = (function (i) {
                        return function () {
                            displayPlaces(sortedPlaces.slice((i - 1) * perPage, i * perPage));
                        };
                    })(i);

                    paginationEl.appendChild(el);
                }

                displayPlaces(sortedPlaces.slice(0, perPage));
            }

            function displayPlaces(places) {
                var listEl = document.getElementById('placesList');
                var menuEl = document.getElementById('menu_wrap');
                var fragment = document.createDocumentFragment();
                var bounds = new kakao.maps.LatLngBounds();

                removeAllChildNods(listEl); 
                removeMarker(); 

                for (var i = 0; i < places.length; i++) {
                    var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x);
                    var marker = addMarker(placePosition, i);
                    var itemEl = getListItem(i, places[i]);

                    bounds.extend(placePosition); 

                    (function (marker, title) {
                        kakao.maps.event.addListener(marker, 'mouseover', function () {
                            displayInfowindow(marker, title);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function () {
                            infowindow.close();
                        });

                        itemEl.onmouseover = function () {
                            displayInfowindow(marker, title);
                        };

                        itemEl.onmouseout = function () {
                            infowindow.close();
                        };

                        itemEl.onclick = function () {
                            focusOnPlace(marker);
                        };

                        kakao.maps.event.addListener(marker, 'click', function () {
                            focusOnPlace(marker);
                        });
                    })(marker, places[i].place_name);

                    fragment.appendChild(itemEl);
                }

                listEl.appendChild(fragment);
                menuEl.scrollTop = 0;

                map.setBounds(bounds); 
            }

            function getListItem(index, places) {
                var el = document.createElement('li');
                var itemStr =
                    '<span class="markerbg marker_' +
                    (index + 1) +
                    '"></span>' +
                    '<div class="info">' +
                    '<h5>' +
                    places.place_name +
                    '</h5>';

                if (places.road_address_name) {
                    itemStr +=
                        '<span>' +
                        places.road_address_name +
                        '</span>' +
                        '<span class="jibun gray">' +
                        places.address_name +
                        '</span>';
                } else {
                    itemStr += '<span>' + places.address_name + '</span>';
                }

                itemStr += '<span class="tel">' + places.phone + '</span></div>';

                el.innerHTML = itemStr;
                el.className = 'item';

                return el;
            }

            function addMarker(position, idx, title) {
                var imageSrc =
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
                var imageSize = new kakao.maps.Size(36, 37);
                var imgOptions = {
                    spriteSize: new kakao.maps.Size(36, 691),
                    spriteOrigin: new kakao.maps.Point(0, idx * 46 + 10),
                    offset: new kakao.maps.Point(13, 37),
                };

                var markerImage = new kakao.maps.MarkerImage(
                    imageSrc,
                    imageSize,
                    imgOptions
                );
                var marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage,
                });

                marker.setMap(map);
                markers.push(marker);

                return marker;
            }
            
            function addSelectedMarker(lat, lng) {
                var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markers_sprites2.png';
                markerImageSize = new kakao.maps.Size(36, 37), 
                markerImageOptions = { 
                    spriteSize: new kakao.maps.Size(125, 146), 
                    spriteOrigin: new kakao.maps.Point(0, 0), 
                    offset: new kakao.maps.Point(12, 37) 
                };
                var markerImage = new kakao.maps.MarkerImage(imageSrc, markerImageSize, markerImageOptions);

                var newMarker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(lat, lng), 
                    image: markerImage
                });
                newMarker.setMap(map); 
                return newMarker;
                }
                function closeAllInfoWindows() {
                    openInfoWindows.forEach(iw => {
                        if (iw instanceof kakao.maps.InfoWindow) {
                            iw.close(); 
                        } else if (iw instanceof kakao.maps.CustomOverlay) {
                            iw.setMap(null);  
                        }
                    });
                    openInfoWindows = []; 
                }

            function removeMarker() {
                markers.forEach(marker => marker.setMap(null));
                markers = []; 
            }

            function displayInfowindow(marker, title) {
                var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }

            function focusOnPlace(marker) {
                var menuEl = document.getElementById('menu_wrap');
                menuEl.style.display = 'none';
                removeMarker(marker); 
                map.setLevel(4);
                
                map.setCenter(marker.getPosition());
                infowindow.close();

                selectedPlace = marker.getPosition();

                var lat = marker.getPosition().getLat();
                var lng = marker.getPosition().getLng();
                selectedPlaceMarker = addSelectedMarker(lat, lng);
                loadUserFavorites();
            }

            // Ï£ºÏ∞®Ïû• Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
            function loadParkingData() {
                var placeData = JSON.parse('{{ parking_data|escapejs }}');
                placeData.forEach(function(place) {
                    parkingData.push({
                        'id': place['id'], 
                        'Ï£ºÏ∞®Ïû•Î™Ö': place['name'],
                        'ÏúÑÎèÑ': parseFloat(place['latitude']) || 0,  
                        'Í≤ΩÎèÑ': parseFloat(place['longitude']) || 0, 
                        'Ï£ºÏ∞®Í∏∞Î≥∏ÏãúÍ∞Ñ': parseFloat(place['base_time']),
                        'Ï£ºÏ∞®Í∏∞Î≥∏ÏöîÍ∏à': parseFloat(place['base_fee']),
                        'Ï∂îÍ∞ÄÎã®ÏúÑÏãúÍ∞Ñ': parseFloat(place['extra_time']),
                        'Ï∂îÍ∞ÄÎã®ÏúÑÏöîÍ∏à': parseFloat(place['extra_fee']),
                        'ÏöîÍ∏àÏ†ïÎ≥¥': place['fee_info'],
                        'Ï£ºÏ∞®Ïû•Ïú†Ìòï': place['type'],
                        'Ïû•Ïï†Ïù∏Ï†ÑÏö©Ï£ºÏ∞®Íµ¨Ïó≠Î≥¥Ïú†Ïó¨Î∂Ä': place['disabled_parking'],
                        'ÏÜåÏû¨ÏßÄÏßÄÎ≤àÏ£ºÏÜå': place['lot_address'],
                        'ÎÇ®ÏùÄÏûêÎ¶¨': isNaN(parseInt(place['available_spots'])) ? null : parseInt(place['available_spots']),
                        'Î≥ÑÏ†êÌèâÍ∑†': parseFloat(place['average_rating']).toFixed(2),
                        'Ï†ÑÏ≤¥ÏûêÎ¶¨': parseInt(place['capacity']),
                        'ÌèâÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å': place['weekday_start'],
                        'ÌèâÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å': place['weekday_end'],
                        'ÌÜ†ÏöîÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å': place['saturday_start'],
                        'ÌÜ†ÏöîÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å': place['saturday_end'],
                        'Í≥µÌú¥ÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å': place['holiday_start'],
                        'Í≥µÌú¥ÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å': place['holiday_end'],
                        'Ï†ÑÌôîÎ≤àÌò∏': place['phone']
                    });
                }); 
                //updateParkingDisplay();
            }

            // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
            function fetchRealTimeData() {
                fetch('/api/real-time-parking/')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(function(realTimeInfo) {
                            const parking = parkingData.find(p => p['ÏÜåÏû¨ÏßÄÏßÄÎ≤àÏ£ºÏÜå'] === realTimeInfo['lot_address']);
                            if (parking) {
                                parking['ÎÇ®ÏùÄÏûêÎ¶¨'] = realTimeInfo['available_spots'] === null ? null : Number(realTimeInfo['available_spots']);
                                // if (parking['ÎÇ®ÏùÄÏûêÎ¶¨'] > 0) {
                                //     console.log(`Ï£ºÏÜå: ${parking['ÏÜåÏû¨ÏßÄÏßÄÎ≤àÏ£ºÏÜå']}, Ï£ºÏ∞®Ïû•: ${parking['Ï£ºÏ∞®Ïû•Î™Ö']}, ÎÇ®ÏùÄÏûêÎ¶¨: ${parking['ÎÇ®ÏùÄÏûêÎ¶¨']}`);
                                // }
                            }
                            
                        });
                        if(selectedPlace){
                            updateVisibleParkingMarkers();
                        }
                        //updateParkingDisplay();
                    })
                    .catch(error => console.error('Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error));
            }

            // Ï£ºÏ∞®Ïû• Îç∞Ïù¥ÌÑ∞ ÌëúÏãú (ÏòàÏãú)
            function updateParkingDisplay() {
                parkingData.forEach(function(place) {
                    console.log(`Ï£ºÏ∞®Ïû•: ${place['Ï£ºÏ∞®Ïû•Î™Ö']} | ÎÇ®ÏùÄ ÏûêÎ¶¨: ${place['ÎÇ®ÏùÄÏûêÎ¶¨']}Í∞ú`);
                    // ÏßÄÎèÑ ÎßàÏª§ ÎòêÎäî DOM ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏
                });
            }

            // Ï¥àÍ∏∞ Î°úÎî©
            fetchRealTimeData();

            // 1Î∂ÑÎßàÎã§ ÏûêÎèô Í∞±Ïã†
            setInterval(fetchRealTimeData, 50000);  // 1Î∂Ñ Í∞ÑÍ≤©

            // ÏßÄÎèÑ Ïù¥Îèô Ïãú Î≥¥Ïù¥Îäî Ï£ºÏ∞®Ïû• ÎßàÏª§Îßå ÌëúÏãúÌïòÎäî Í∏∞Îä• Ï∂îÍ∞Ä
            kakao.maps.event.addListener(map, 'bounds_changed', function () {
                if (!selectedPlace) return;
                clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => {
                        updateVisibleParkingMarkers();
                    }, 300);
                });

            function updateVisibleParkingMarkers() {
                var bounds = map.getBounds(); 

                removeMarker(); 

                var visibleParking = parkingData.filter(parking => {
                var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ);
                
                //ÏßÄÎèÑ ÌôîÎ©¥ ÏïàÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                var isInBounds = bounds.contain(parkingLatLng);

                //ÏÑ†ÌÉùÌïú Ïû•ÏÜåÏóêÏÑú 2km Ïù¥ÎÇ¥Ïù∏ÏßÄ ÌôïÏù∏
                var distanceFromSelected = getDistance(selectedPlace, parkingLatLng);
                var isWithin2km = distanceFromSelected <= 2; // 2km Ïù¥ÎÇ¥ Ïó¨Î∂Ä
                
                return isInBounds && isWithin2km;
                });

                visibleParking.forEach((parking, index) => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ);
                    if (favoriteParkingIds.includes(parking.id)) {
                        addFavoriteMarker(parkingLatLng, index, parking.Ï£ºÏ∞®Ïû•Î™Ö, parking.ÎÇ®ÏùÄÏûêÎ¶¨, parking);
                    } else {
                        addDefaultMarker(parkingLatLng, index, parking.Ï£ºÏ∞®Ïû•Î™Ö, parking.ÎÇ®ÏùÄÏûêÎ¶¨, parking);
                    }
                });
            }
            function addFavoriteMarker(position, idx, title, seat, parking) {
                if (openInfoWindows[idx]) {
                    if (openInfoWindows[idx] instanceof kakao.maps.InfoWindow) {
                        openInfoWindows[idx].close();
                    } else {
                        openInfoWindows[idx].setMap(null);
                    }
                }

                let markerImageUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; // Ï∞úÌïú Ï£ºÏ∞®Ïû• ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ
                let markerImage = new kakao.maps.MarkerImage(markerImageUrl, new kakao.maps.Size(24, 39));

                let marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage
                });

                marker.setMap(map);
                markers.push(marker);

                let textColor = "";
                if (seat/parking.Ï†ÑÏ≤¥ÏûêÎ¶¨ >= 0.5) textColor = "green";
                else if (seat/parking.Ï†ÑÏ≤¥ÏûêÎ¶¨ >= 0.1) textColor = "orange";
                else if (!isNaN(seat)) textColor = "red";  // seatÏù¥ Ïà´ÏûêÏùº ÎïåÎßå Ï†ÅÏö©

                // seatÏù¥ null ÎòêÎäî NaNÏù¥Î©¥ ÏïÑÏù¥ÏΩò ÌëúÏãú, ÏïÑÎãàÎ©¥ Ïà´Ïûê ÌëúÏãú
                let seatContent = (seat === null || seat === undefined || isNaN(seat))
                    ? `<i class="ri-car-fill" style="font-size:1rem; color:black;"></i>`  // ÏïÑÏù¥ÏΩò ÌÅ¨Í∏∞ 1rem, ÏÉâÏÉÅ Í≤ÄÏ†ï
                    : `<span style="color:${textColor};">${seat}</span>`;  // Ïà´ÏûêÏóêÎßå ÏÉâÏÉÅ Ï†ÅÏö©

                let overlayContent = `<div style="position:relative;width:18px;height:18px;text-align:center;
                                        font-weight:bold;background:white;border-radius:50%;
                                        line-height:20px;font-size:12px;bottom:27px; left:0.5px; pointer-events: none;">
                                        ${seatContent}
                                    </div>`;

                let overlay = new kakao.maps.CustomOverlay({
                    content: overlayContent,
                    position: position,
                    yAnchor: 0.5
                });

                overlay.setMap(map);
                openInfoWindows[idx] = overlay;

                kakao.maps.event.addListener(marker, 'click', function () {
                    map.setCenter(marker.getPosition());
                    showParkingDetail(parking);
                });

                return marker;
            }

            function addDefaultMarker(position, idx, title, seat, parking) {
                if (openInfoWindows[idx]) {
                    if (openInfoWindows[idx] instanceof kakao.maps.InfoWindow) {
                        openInfoWindows[idx].close();
                    } else {
                        openInfoWindows[idx].setMap(null);
                    }
                }

                var marker = new kakao.maps.Marker({
                    position: position, 
                });

                marker.setMap(map);
                markers.push(marker);

                let textColor = "";
                if (seat/parking.Ï†ÑÏ≤¥ÏûêÎ¶¨ >= 0.5) textColor = "green";
                else if (seat/parking.Ï†ÑÏ≤¥ÏûêÎ¶¨ >= 0.1) textColor = "orange";
                else if (!isNaN(seat)) textColor = "red";  // seatÏù¥ Ïà´ÏûêÏùº ÎïåÎßå Ï†ÅÏö©

                // seatÏù¥ null ÎòêÎäî NaNÏù¥Î©¥ ÏïÑÏù¥ÏΩò ÌëúÏãú, ÏïÑÎãàÎ©¥ Ïà´Ïûê ÌëúÏãú
                let seatContent = (seat === null || seat === undefined || isNaN(seat))
                    ? `<i class="ri-car-fill" style="font-size:1rem; color:black;"></i>`  
                    : `<span style="color:${textColor}; font-size: ${seat >= 100 ? '1.1rem' : '1.3rem'};">${seat}</span>`;  

                let overlayContent = `<div style="position:relative;width:18px;height:18px;text-align:center;
                                        font-weight:bold;background:white;border-radius:50%;
                                        line-height:20px;font-size:12px;bottom:27px;left:0.5px; pointer-events: none;">
                                        ${seatContent}
                                    </div>`;

                let overlay = new kakao.maps.CustomOverlay({
                    content: overlayContent,
                    position: position,
                    yAnchor: 0.5
                });

                overlay.setMap(map);
                openInfoWindows[idx] = overlay;

                kakao.maps.event.addListener(marker, 'click', function () {
                    map.setCenter(marker.getPosition());
                    showParkingDetail(parking);
                });

                return marker;
            }

            function removeAllChildNods(el) {
                while (el.hasChildNodes()) {
                    el.removeChild(el.lastChild);
                }
            }
            function showClosestParkingLots() {
                visibleparkinglot = [];  // ‚≠ê Ï§ëÎ≥µ Î∞©ÏßÄ: Î¶¨Ïä§Ìä∏ Ï¥àÍ∏∞Ìôî
                var parkingListEl = document.getElementById('parkingList');
                var parkingListDelete = document.getElementById("delete-btn");
                var parkingList = document.getElementById("list-btn");
                parkingListEl.innerHTML = ""; 

                var hours = parseInt(document.getElementById('hours').value, 10) || 0;
                var minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
                parkingTime = (hours * 60) + minutes; 

                if (parkingTime <= 0) {
                    parkingTime = null;
                }

                visibleparkinglot = parkingData.map(parking => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ);
                    var distance = getDistance(selectedPlace, parkingLatLng);
                    return { ...parking, distance };
                }).filter((parking, index, self) =>
                    parking.distance <= 2 &&
                    index === self.findIndex(p => p.id === parking.id)  // Ï§ëÎ≥µ Ï†úÍ±∞
                );

                if (visibleparkinglot.length === 0) {
                    parkingListEl.innerHTML = "<li>ÌòÑÏû¨ ÏßÄÎèÑÏóê ÌëúÏãúÎêú Ï£ºÏ∞®Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§.</li>";
                }

                visibleparkinglot.sort((a, b) => a.distance - b.distance);
                visibleparkinglot.forEach((parking, index) => {
                    var feeText = ""; 

                    if (parkingTime !== null) {
                        var totalFee = calculateFee(parking, parkingTime);
                        feeText = ` - ÏöîÍ∏à: ${totalFee}`;
                    }

                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.Ï£ºÏ∞®Ïû•Î™Ö}</b> (${parking.distance.toFixed(2)} km)${feeText} (<i class="ri-star-fill"></i> ${parking.Î≥ÑÏ†êÌèâÍ∑† || "ÌèâÏ†ê ÏóÜÏùå"})`;
                    li.onclick = function () {
                        showParkingDetail(parking);
                        var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ); 
                        map.setCenter(parkingLatLng); 
                    };
                    parkingListEl.appendChild(li);
                });

                parkingListDelete.addEventListener("click", function () {
                    parkingListWrap.style.display = "none";
                    parkingList.style.display = "block"; 
        });

                document.getElementById('parkingListWrap').style.display = "block"; 
                document.getElementById('parkingDetailWrap').style.display = "none"; 
            }

            function calculateFee(parking, time) {
                    var basicTime = parseInt(parking.Ï£ºÏ∞®Í∏∞Î≥∏ÏãúÍ∞Ñ, 10) || 0;
                    var basicFee = parseInt(parking.Ï£ºÏ∞®Í∏∞Î≥∏ÏöîÍ∏à, 10) || 0;
                    var unitTime = parseInt(parking.Ï∂îÍ∞ÄÎã®ÏúÑÏãúÍ∞Ñ, 10) || 1;
                    var unitFee = parseInt(parking.Ï∂îÍ∞ÄÎã®ÏúÑÏöîÍ∏à, 10) || 0;
                    var dailyFee = parseInt(parking["1ÏùºÏ£ºÏ∞®Í∂åÏöîÍ∏à"], 10) || 0;
                    var feeInfo = parking.ÏöîÍ∏àÏ†ïÎ≥¥;
                    if (feeInfo === "Î¨¥Î£å") {
                        return feeInfo;
                    }

                    if (time >= 1440 && dailyFee !== 0) return dailyFee + "Ïõê"; // 24ÏãúÍ∞Ñ Ïù¥ÏÉÅÏù¥Î©¥ 1Ïùº Ï£ºÏ∞®Í∂å ÏöîÍ∏à Ï†ÅÏö©
                    if (time <= basicTime) return basicFee + "Ïõê"; // Í∏∞Î≥∏ ÏãúÍ∞Ñ ÎÇ¥Ïù¥Î©¥ Í∏∞Î≥∏ ÏöîÍ∏à Ï†ÅÏö©

                    var extraTime = time - basicTime;
                    var extraUnits = Math.ceil(extraTime / unitTime); // Ïò¨Î¶º Ï≤òÎ¶¨
                    return (basicFee + (extraUnits * unitFee)) + "Ïõê";
                }
                
            function calculateAndSortParkingFees() {
                var hours = parseInt(document.getElementById('hours').value, 10) || 0;
                var minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
                parkingTime = (hours * 60) + minutes; 

                if (parkingTime <= 0) {
                    alert("Ïò¨Î∞îÎ•∏ ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                    parkingTime = null;
                    return;
                }

                var parkingListEl = document.getElementById('parkingList');
                parkingListEl.innerHTML = ""; 

                if (visibleparkinglot.length === 0) {
                    parkingListEl.innerHTML = "<li>ÌòÑÏû¨ ÏßÄÎèÑÏóê ÌëúÏãúÎêú Ï£ºÏ∞®Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§.</li>";
                    return;
                }
                
                    var sortedParking = visibleparkinglot.map(parking => {
                    var totalFee = calculateFee(parking, parkingTime);
                    var numericFee = (totalFee === "Î¨¥Î£å" || totalFee === "0Ïõê") ? 0 : parseInt(totalFee.replace("Ïõê", ""), 10) || Infinity;

                    return {
                        ...parking,
                        totalFee,
                        numericFee
                    };
                }).sort((a, b) => a.numericFee - b.numericFee);

                sortedParking.forEach((parking, index) => {
                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.Ï£ºÏ∞®Ïû•Î™Ö}</b> (${parking.distance.toFixed(2)} km) - ÏöîÍ∏à: ${parking.totalFee} (<i class="ri-star-fill"></i> ${parking.Î≥ÑÏ†êÌèâÍ∑† || "ÌèâÏ†ê ÏóÜÏùå"})`;
                    li.onclick = function () {
                        showParkingDetail(parking);
                        var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ); 
                        map.setCenter(parkingLatLng); 
                    };
                    parkingListEl.appendChild(li);
                });

                document.getElementById('parkingListWrap').style.display = "block";
            }

            function showRatingParkingLots() {
                var parkingListEl = document.getElementById('parkingList');
                var parkingListDelete = document.getElementById("delete-btn");
                var parkingList = document.getElementById("list-btn"); 

                var hours = parseInt(document.getElementById('hours').value, 10) || 0;
                var minutes = parseInt(document.getElementById('minutes').value, 10) || 0;
                parkingTime = (hours * 60) + minutes; 
                parkingListEl.innerHTML = "";

                if (parkingTime <= 0) {
                    parkingTime = null;
                }

                visibleparkinglot = parkingData.map(parking => {
                    var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ);
                    var distance = getDistance(selectedPlace, parkingLatLng);
                    return { ...parking, distance };
                }).filter((parking, index, self) =>
                    parking.distance <= 2 &&
                    index === self.findIndex(p => p.id === parking.id)  
                );

                if (visibleparkinglot.length === 0) {
                    parkingListEl.innerHTML = "<li>ÌòÑÏû¨ ÏßÄÎèÑÏóê ÌëúÏãúÎêú Ï£ºÏ∞®Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§.</li>";
                    return;
                }
                // Î≥ÑÏ†êÏàú Ï†ïÎ†¨ (Í∞ôÏùÄ Î≥ÑÏ†êÏù¥Î©¥ Í±∞Î¶¨Ïàú Ï†ïÎ†¨)
                visibleparkinglot.sort((a, b) => {
                    let ratingDiff = (b.Î≥ÑÏ†êÌèâÍ∑† || 0) - (a.Î≥ÑÏ†êÌèâÍ∑† || 0); 
                    if (ratingDiff !== 0) return ratingDiff; 
                    return a.distance - b.distance; 
                });

                visibleparkinglot.forEach((parking, index) => {
                    var feeText = ""; 

                    if (parkingTime !== null) {
                        var totalFee = calculateFee(parking, parkingTime);
                        feeText = ` - ÏöîÍ∏à: ${totalFee}`;
                    }

                    var li = document.createElement('li');
                    li.innerHTML = `<b>${index + 1}. ${parking.Ï£ºÏ∞®Ïû•Î™Ö}</b> (${parking.distance.toFixed(2)} km)${feeText} (<i class="ri-star-fill"></i> ${parking.Î≥ÑÏ†êÌèâÍ∑† || "ÌèâÏ†ê ÏóÜÏùå"})`;
                    li.onclick = function () {
                        showParkingDetail(parking);
                        var parkingLatLng = new kakao.maps.LatLng(parking.ÏúÑÎèÑ, parking.Í≤ΩÎèÑ); 
                        map.setCenter(parkingLatLng); 
                    };
                    parkingListEl.appendChild(li);
                });

                parkingListDelete.addEventListener("click", function () {
                    parkingListWrap.style.display = "none";
                    parkingList.style.display = "block"; 
                });

                document.getElementById('parkingListWrap').style.display = "block"; 
                document.getElementById('parkingDetailWrap').style.display = "none"; 
                }

                function parkingUserDistance(parking) {
                    return new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            return reject("Í±∞Î¶¨ Í≥ÑÏÇ∞ Ïò§Î•ò");
                        }

                        navigator.geolocation.getCurrentPosition(function (position) {
                            var userLat = position.coords.latitude;
                            var userLng = position.coords.longitude;
                            var userPosition = new kakao.maps.LatLng(userLat, userLng);

                            var parkingLat = parking.ÏúÑÎèÑ;
                            var parkingLng = parking.Í≤ΩÎèÑ;
                            var parkingPosition = new kakao.maps.LatLng(parkingLat, parkingLng);

                            var distance = getDistance(userPosition, parkingPosition);
                            resolve(distance);
                        }, function (error) {
                            reject("Í±∞Î¶¨ Í≥ÑÏÇ∞ Ïò§Î•ò");
                        });
                    });
                }


                async function showParkingDetail(parking) { 
                try {
                    if (window.location.search.includes("parking_id=")){
                        document.getElementById('return-btn').style.display = "none"; 
                    } 
                    else{
                        document.getElementById('return-btn').style.display = "block"; 
                    }
                    var distance = await parkingUserDistance(parking); // ÎπÑÎèôÍ∏∞ Ï≤òÎ¶¨
                    var parkingInfodistance = document.getElementById('parkingInfo-distance');

                    if (typeof distance === "number" && !isNaN(distance)) {
                        parkingInfodistance.innerHTML = `<span style="font-size: 1.7rem; font-weight: 650;">Ïù¥Í≥≥ÏóêÏÑú&nbsp;${distance.toFixed(2)} km</span>`;
                    } else {
                        parkingInfodistance.innerHTML = `<span style="font-size: 1.7rem; font-weight: 650; color: red;">Í±∞Î¶¨ Í≥ÑÏÇ∞ Ïò§Î•ò</span>`;
                    }

                    var parkingInfostar = document.getElementById('parkingInfo-star');
                    var titleElement = document.getElementById('parkingTitle');
                    var infoElement1 = document.getElementById('parkingInfo1'); 
                    var infoElement2 = document.getElementById('parkingInfo2');
                    var infoElement3 = document.getElementById('parkingInfo3');
                    var infoElement4 = document.getElementById('parkingInfo4');
                    var infoElement5 = document.getElementById('parkingInfo5');
                    var infoElement6 = document.getElementById('parkingInfo6');
                    var infoElement7 = document.getElementById('parkingInfo7');
                    var infoElement8 = document.getElementById('parkingInfo8');
                    var returnBtn = document.getElementById('return-btn');
                    var deleteBtn = document.getElementById('delete-btn2');

                    if (titleElement && infoElement1 && infoElement2) {
                        parkingInfostar.innerHTML = `<i class="ri-star-fill" style="font-size: 1.8rem;"></i>&nbsp;<span style="font-size: 1.7rem; font-weight: 650; margin-right: 15px;">${parking.Î≥ÑÏ†êÌèâÍ∑† || "ÌèâÏ†ê ÏóÜÏùå"}`;
                        titleElement.innerText = parking.Ï£ºÏ∞®Ïû•Î™Ö || "Ï£ºÏ∞®Ïû• Ï†ïÎ≥¥ ÏóÜÏùå";
                        infoElement1.innerText = `${parking.ÏöîÍ∏àÏ†ïÎ≥¥ || "ÏöîÍ∏à Ï†ïÎ≥¥ ÏóÜÏùå"} Ï£ºÏ∞®Ïû•`;
                        infoElement2.innerHTML = `<i class="ri-car-fill" style="color: #606060;"></i>&nbsp;Ï£ºÏ∞®Ïû• Ïú†Ìòï:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.Ï£ºÏ∞®Ïû•Ïú†Ìòï || "Ïú†Ìòï Ï†ïÎ≥¥ ÏóÜÏùå"}</span><br>`;
                        infoElement3.innerHTML = `<i class="ri-wheelchair-fill" style="color: #606060;"></i>&nbsp;Ïû•Ïï†Ïù∏Ï†ÑÏö©Ï£ºÏ∞®Íµ¨Ïó≠:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.Ïû•Ïï†Ïù∏Ï†ÑÏö©Ï£ºÏ∞®Íµ¨Ïó≠Î≥¥Ïú†Ïó¨Î∂Ä ? "Î≥¥Ïú†" : "ÎØ∏Î≥¥Ïú†"}</span><br>`;
                        infoElement5.innerHTML = `<i class="ri-alarm-line" style="color: #606060;"></i>&nbsp;ÌèâÏùºÏö¥ÏòÅÏãúÍ∞Ñ:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.ÌèâÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å || "??:??"}-${parking.ÌèâÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å || "??:??"}</span><br>`;
                        infoElement6.innerHTML = `<i class="ri-alarm-line" style="color: #606060;"></i>&nbsp;ÌÜ†ÏöîÏùºÏö¥ÏòÅÏãúÍ∞Ñ:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.ÌèâÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å || "??:??"}-${parking.ÌÜ†ÏöîÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å || "??:??"}</span><br>`;
                        infoElement7.innerHTML = `<i class="ri-alarm-line" style="color: #606060;"></i>&nbsp;Í≥µÌú¥ÏùºÏö¥ÏòÅÏãúÍ∞Ñ:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.Í≥µÌú¥ÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å || "??:??"}-${parking.Í≥µÌú¥ÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å || "??:??"}</span><br>`;
                        infoElement8.innerHTML = `<i class="ri-phone-fill" style="color: #606060;"></i>&nbsp;Ï†ÑÌôîÎ≤àÌò∏:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.Ï†ÑÌôîÎ≤àÌò∏ || "Ï†ÑÌôîÎ≤àÌò∏ Ï†ïÎ≥¥ ÏóÜÏùå"}</span><br>`;

                        if (parking.ÎÇ®ÏùÄÏûêÎ¶¨ === null || parking.ÎÇ®ÏùÄÏûêÎ¶¨ === undefined || isNaN(parking.ÎÇ®ÏùÄÏûêÎ¶¨)) {
                            infoElement4.innerHTML = `<i class="ri-parking-box-fill" style="color: #606060;"></i>&nbsp;Ï†ÑÏ≤¥ÏûêÎ¶¨:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.Ï†ÑÏ≤¥ÏûêÎ¶¨}</span>`;
                        } else {
                            infoElement4.innerHTML = `<i class="ri-parking-box-fill" style="color: #606060;"></i>&nbsp;ÎÇ®ÏùÄÏûêÎ¶¨/Ï†ÑÏ≤¥ÏûêÎ¶¨:&nbsp;<span style="color:#4130f5; font-weight: bold;">${parking.ÎÇ®ÏùÄÏûêÎ¶¨}/${parking.Ï†ÑÏ≤¥ÏûêÎ¶¨}</span>`;
                        }
                    }

                    selectedParkingLotId = parking.id;  
                    updateHeartIcon(selectedParkingLotId);

                    document.getElementById('parkingListWrap').style.display = "none"; 
                    document.getElementById('parkingDetailWrap').style.display = "block";

                    deleteBtn.addEventListener("click", function () {
                        if (window.location.search.includes("parking_id=")){
                            document.getElementById('list-btn').style.display = "block";
                            document.getElementById('parkingDetailWrap').style.display = "none";
                        } 
                        else{
                            showClosestParkingLots();
                            document.getElementById('list-btn').style.display = "block";
                            document.getElementById('parkingListWrap').style.display = "none"; 
                            document.getElementById('parkingDetailWrap').style.display = "none";
                        }
                    }); 

                    returnBtn.addEventListener("click", function () {
                            showClosestParkingLots();
                            document.getElementById('parkingListWrap').style.display = "block"; 
                            document.getElementById('parkingDetailWrap').style.display = "none";
                    });

                    loadReviews(); 

                } catch (error) {
                    parkingInfodistance.innerHTML = `<span style="font-size: 1.7rem; font-weight: 650; color: red;">Í±∞Î¶¨ Í≥ÑÏÇ∞ Ïò§Î•ò</span>`;
                }
            }

            const DEG_TO_RAD = Math.PI / 180;

            function getDistance(latlng1, latlng2) {
                var earthRadius = 6371;
                var dLat = (latlng2.getLat() - latlng1.getLat()) * DEG_TO_RAD;
                var dLng = (latlng2.getLng() - latlng1.getLng()) * DEG_TO_RAD;

                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(latlng1.getLat() * DEG_TO_RAD) *
                    Math.cos(latlng2.getLat() * DEG_TO_RAD) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);

                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return earthRadius * c;
            }

            function toggleParkingList() {
                var parkingListWrap = document.getElementById("parkingListWrap");
                var parkingList = document.getElementById("list-btn");

                if (!selectedPlace) {
                    alert("Ïû•ÏÜå ÏÑ†Ï†ïÏùÑ Î®ºÏ†Ä ÌïòÏÑ∏Ïöî!");
                    parkingListWrap.style.display = "none"; 
                    return;
                }

                if (parkingListWrap.style.display === "none" || parkingListWrap.style.display === "") {
                    showClosestParkingLots();
                    parkingList.style.display = "none"; 
                } else {
                    parkingListWrap.style.display = "none"; 
                }
            }
            //document.addEventListener('DOMContentLoaded', () => {
               // loadReviews(); // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∏∞Ï°¥ Î¶¨Î∑∞ Î°úÎìú
            //});  

            const reviewContainer = document.querySelector('.review-list');

            function toggleReview() {
                const review = document.getElementById('review');
                const toggleBtn=document.getElementById('toggle-btn');
                review.classList.toggle('active');

                if (review.classList.contains('active')) {
                    toggleBtn.classList.remove('ri-arrow-down-s-fill');
                    toggleBtn.classList.add('ri-arrow-up-s-fill');
                } else {
                    toggleBtn.classList.remove('ri-arrow-up-s-fill');
                    toggleBtn.classList.add('ri-arrow-down-s-fill');
                }
            }

            function toggleLike() {
                const heartIcon = document.getElementById("toggle-btn");
            
                if (!heartIcon) {
                    console.error("üö® Ïò§Î•ò: ÌïòÌä∏ ÏïÑÏù¥ÏΩòÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                    return;
                }
                const isLiked = heartIcon.classList.contains("ri-heart-3-fill");

                heartIcon.classList.toggle("ri-heart-3-line", isLiked);
                heartIcon.classList.toggle("ri-heart-3-fill", !isLiked);

                heartIcon.style.color = isLiked ? "black" : "red";
            }


            
            function loadReviews() {
                console.log( "selectedParkingLotId Í∞í ÌôïÏù∏:", selectedParkingLotId);

                const url = `/api/reviews/${selectedParkingLotId}/`;
                console.log('Fetching URL:', url);
            
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        reviewContainer.innerHTML = ''; 
                        data.reviews.forEach(review => {
                            console.log("Î¶¨Î∑∞ Í∞ùÏ≤¥ ÌôïÏù∏:", review);
                            const reviewElement = `
                                <div class="review-item" id="review-${review.id}">
                                    <strong>${review.user__username}</strong>
                                    <span><i class="ri-star-fill"></i> ${review.rating}</span>
                                    <p id="content-${review.id}">${review.content || ''}</p>

                                    ${review.user__username === currentUser ? `
                                        <a href="javascript:void(0);" onclick="deleteReview(${review.id})">
                                            <i class="ri-delete-bin-6-line"></i> [ÏÇ≠Ï†ú]
                                        </a>
                                        <a href="javascript:void(0);" onclick="editReview(${review.id}, ${review.rating}, '${review.content}')">
                                            <i class="ri-edit-line"></i> [ÏàòÏ†ï]
                                        </a>
                                    ` : ''}
                                <hr>
                                </div>
                            `;
                            reviewContainer.innerHTML += reviewElement;
                        });
                        initializeStarRating();
                    })
                    .catch(error => console.error('Î¶¨Î∑∞ Î°úÎìú Ïã§Ìå®:', error));
            }
            
            function initializeStarRating() {
                document.querySelectorAll(".star-rating i").forEach(star => {
                    star.addEventListener("click", () => {
                        const rating = parseInt(star.getAttribute("data-value"), 10);
                        selectedRating = rating; //  Î≥ÑÏ†ê Í∞í Ï†ÄÏû•
                        updateStars(selectedRating);
                        document.getElementById("rating-display").textContent = `${rating}Ï†ê`;
                    });
                });
            }
            function updateStars(rating) {
                document.querySelectorAll(".star-rating i").forEach(star => {
                    const value = parseInt(star.getAttribute("data-value"), 10);
                    star.classList.toggle("ri-star-fill", value <= rating);
                    star.classList.toggle("ri-star-line", value > rating);
                });
            }
            
            function editReview(reviewId, currentRating, currentContent) {
                console.log("ÏàòÏ†ïÌï† Î¶¨Î∑∞ ID:", reviewId); // ‚úÖ Î¶¨Î∑∞ ID Í∞í ÌôïÏù∏
                const reviewElement = document.getElementById(`review-${reviewId}`);
                if (!reviewElement) return;
            
                reviewElement.innerHTML = `
                    <div class="fix-container">
                        <div class="star-rating">
                            ${[1, 2, 3, 4, 5].map(star => `
                                <i class="ri-star-line" data-value="${star}" onclick="selectRating(${star}, ${reviewId})"></i>
                            `).join('')}
                            <p id="rating-display-${reviewId}">${currentRating}Ï†ê</p>
                        </div>
                        <textarea id="edit-content-${reviewId}">${currentContent}</textarea>
                        <button class="fix-btn" onclick="updateReview(${reviewId})">ÏàòÏ†ï ÏôÑÎ£å</button>
                    </div>
                    <div class="fix-container">
                        <div class="star-rating">
                            ${[1, 2, 3, 4, 5].map(star => `
                                <i class="ri-star-line" data-value="${star}" onclick="selectRating(${star}, ${reviewId})"></i>
                            `).join('')}
                            <p id="rating-display-${reviewId}">${currentRating}Ï†ê</p>
                        </div>
                        <textarea id="edit-content-${reviewId}">${currentContent}</textarea>
                        <button class="fix-btn" onclick="updateReview(${reviewId})">ÏàòÏ†ï ÏôÑÎ£å</button>
                    </div>
                `;
                selectRating(currentRating, reviewId);
            }
            
            function selectRating(rating, reviewId) {
                const stars = document.querySelectorAll(`#review-${reviewId} .star-rating i`);
                stars.forEach(star => {
                    const value = parseInt(star.getAttribute("data-value"), 10);
                    star.classList.toggle("ri-star-fill", value <= rating);
                    star.classList.toggle("ri-star-line", value > rating);
                });
                document.getElementById(`rating-display-${reviewId}`).textContent = `${rating}Ï†ê`;
                selectedRating = rating;
            }
            
            async function updateReview(reviewId) {
                const content = document.getElementById(`edit-content-${reviewId}`).value.trim();
                console.log("Î¶¨Î∑∞ Î≥ÑÏ†ê ÌôïÏù∏:", document.getElementById(`edit-content-${reviewId}`).value);
                if (!selectedRating) {
                    alert("Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                if (!content) {
                    alert("Î¶¨Î∑∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                    return;
                }
                try {
                    const response = await fetch(`/api/update_review/${reviewId}/`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            rating: selectedRating,
                            content: content,
                        }),
                    });
                    if (!response.ok) {
                        throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`);
                    }
                    alert("‚úÖ Î¶¨Î∑∞Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!");
                    loadReviews();
                } catch (error) {
                    console.error("‚ùå Î¶¨Î∑∞ ÏàòÏ†ï Ïã§Ìå®:", error);
                    alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.");
                }
            }
            
            async function deleteReview(reviewId) {
                if (!confirm("Ï†ïÎßêÎ°ú Ïù¥ Î¶¨Î∑∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    return;
                }
            
                try {
                    const response = await fetch(`/api/delete_review/${reviewId}/`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    });
            
                    if (!response.ok) {
                        throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`);
                    }
            
                    alert("‚úÖ Î¶¨Î∑∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
                    loadReviews();
                } catch (error) {
                    console.error("‚ùå Î¶¨Î∑∞ ÏÇ≠Ï†ú Ïã§Ìå®:", error);
                    alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.");
                }
            }
            

            // ‚≠ê Î¶¨Î∑∞ Îì±Î°ù Ìï®Ïàò ÏàòÏ†ï (selectedRating ÏÇ¨Ïö©)
            async function addReview() {
                const content = document.getElementById("contentInput").value.trim();
                const parkingLotId = selectedParkingLotId; // ÏÑ†ÌÉùÎêú Ï£ºÏ∞®Ïû• ID Í∞ÄÏ†∏Ïò§Í∏∞

                if (!selectedRating) {
                    alert("Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }

                if (!content) {
                    alert("Î¶¨Î∑∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                    return;
                }

                if (!parkingLotId) {
                    alert("Ï£ºÏ∞®Ïû•ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
                    return;
                }

                try {
                    const response = await fetch("/api/add_review/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            rating: selectedRating, // ‚≠ê ÏÑ†ÌÉùÎêú Î≥ÑÏ†ê Í∞í ÏÇ¨Ïö©
                            content: content,
                            parking_lot_id: parkingLotId,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        alert(`Î¶¨Î∑∞ Îì±Î°ù Ïã§Ìå®: ${data.error}`);
                    } else {
                        alert("‚úÖ Î¶¨Î∑∞Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!");
                        console.log("‚úÖ Î¶¨Î∑∞ Ï∂îÍ∞ÄÎê®:", data);
                        loadReviews(); // Î¶¨Î∑∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                        resetStars(); // Î≥ÑÏ†ê Ï¥àÍ∏∞Ìôî
                        document.getElementById("contentInput").value = ""; // ÏûÖÎ†•ÎÇ¥Ïö© Ï¥àÍ∏∞Ìôî
                    }
                } catch (error) {
                    console.error(`‚ùå Î¶¨Î∑∞ Ï∂îÍ∞Ä Ïã§Ìå®:${error}`);
                    if (error.message == "ÏÑúÎ≤Ñ Ïò§Î•ò: 400"){
                        alert(`Î¶¨Î∑∞ Îì±Î°ù Ïã§Ìå®: Ïú†Ï†ÄÎäî Ìïú Ï£ºÏ∞®Ïû• Îãπ Ìïú Í∞úÏùò Î¶¨Î∑∞Îßå ÏûëÏÑ± Í∞ÄÎä•Ìï©ÎãàÎã§.`);
                    }
                    else{
                        alert(`Î¶¨Î∑∞ Îì±Î°ù Ïã§Ìå®: ${error.message}`);
                    }
                }
            }
            function resetStars() {
                const stars = document.querySelectorAll(".star-rating i");
                stars.forEach(star => {
                    star.classList.remove("ri-star-fill");
                    star.classList.add("ri-star-line");
                });
            
                selectedRating = 0; // Î≥ÑÏ†ê Í∞í Ï¥àÍ∏∞Ìôî
                const ratingDisplay = document.getElementById("rating-display");
                if (ratingDisplay) {
                    ratingDisplay.textContent = "0Ï†ê"; // Î≥ÑÏ†ê ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî
                }
            }
            function updateHeartIcon(parkingId) {
                fetch('/api/favorites/')
                    .then(response => response.json())
                    .then(data => {
                        const favorited = data.liked_parking_lots.some(lot => lot.id === parkingId);
                        const heartIcon = document.getElementById("toggle-btn");
            
                        if (heartIcon) {
                            if (favorited) {
                                heartIcon.classList.remove("ri-heart-3-line");
                                heartIcon.classList.add("ri-heart-3-fill");
                                heartIcon.style.color = "red";
                            } else {
                                heartIcon.classList.remove("ri-heart-3-fill");
                                heartIcon.classList.add("ri-heart-3-line");
                                heartIcon.style.color = "black";
                            }
                        }
                    })
                    .catch(error => console.error("üö® Ï∞úÌïú Ï£ºÏ∞®Ïû• Î°úÎìú Ïã§Ìå®:", error));
            }
            
            function toggleLike() { 
                const heartIcon = document.getElementById("toggle-btn");
                const parkingId = selectedParkingLotId; 
                
                const isLoggedIn = "{{ user.is_authenticated }}" === "True";  

                if (!isLoggedIn) {
                    alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                    return;
                }
                fetch('/api/toggle_favorite/', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify({ parking_id: parkingId })  
                })
                .then(response => {
                    if (response.status === 403) {
                        alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."); 
                        return Promise.reject("Î°úÍ∑∏Ïù∏ ÌïÑÏöî");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.favorited) {
                        heartIcon.classList.remove("ri-heart-3-line");
                        heartIcon.classList.add("ri-heart-3-fill");
                        heartIcon.style.setProperty("color", "red", "important");
                    } else {
                        heartIcon.classList.remove("ri-heart-3-fill");
                        heartIcon.classList.add("ri-heart-3-line");
                        heartIcon.style.setProperty("color", "black", "important");

                    }
                })
                .catch(error => console.error("üö® Ï¢ãÏïÑÏöî Í∏∞Îä• Ïò§Î•ò:", error));
            }
            document.getElementById("location-btn").addEventListener("click", function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var lat = position.coords.latitude;
                        var lon = position.coords.longitude;
                        var locPosition = new kakao.maps.LatLng(lat, lon);

                        selectedPlace = locPosition;
                        if (selectedPlaceMarker) {
                        selectedPlaceMarker.setMap(null);
                        selectedPlaceMarker = null;
                    }

                    closeAllInfoWindows();

                        var dummyMarker = { getPosition: () => locPosition }; // ÎßàÏª§ ÏóÜÏù¥ ÏúÑÏπò Ï†ÑÎã¨
                        focusOnPlace(dummyMarker);
                    }, function(error) {
                        console.error("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§:", error);}
                    );
                } else {
                    alert("GeolocationÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.");
                }
            });
        </script>
        {% if selected_parking %}
        <script>
            window.onload = function () {
            let selectedParking = JSON.parse('{{ selected_parking|escapejs }}');
            selectedParking = {
                'id': selectedParking['id'],
                'Ï£ºÏ∞®Ïû•Î™Ö': selectedParking['name'],
                'ÏúÑÎèÑ': parseFloat(selectedParking['latitude']) || 0,  
                'Í≤ΩÎèÑ': parseFloat(selectedParking['longitude']) || 0, 
                'Ï£ºÏ∞®Í∏∞Î≥∏ÏãúÍ∞Ñ': parseFloat(selectedParking['base_time']),
                'Ï£ºÏ∞®Í∏∞Î≥∏ÏöîÍ∏à': parseFloat(selectedParking['base_fee']),
                'Ï∂îÍ∞ÄÎã®ÏúÑÏãúÍ∞Ñ': parseFloat(selectedParking['extra_time']),
                'Ï∂îÍ∞ÄÎã®ÏúÑÏöîÍ∏à': parseFloat(selectedParking['extra_fee']),
                'ÏöîÍ∏àÏ†ïÎ≥¥': selectedParking['fee_info'],
                'Ï£ºÏ∞®Ïû•Ïú†Ìòï': selectedParking['type'],
                'Ïû•Ïï†Ïù∏Ï†ÑÏö©Ï£ºÏ∞®Íµ¨Ïó≠Î≥¥Ïú†Ïó¨Î∂Ä': selectedParking['disabled_parking'],
                'ÏÜåÏû¨ÏßÄÏßÄÎ≤àÏ£ºÏÜå': selectedParking['lot_address'],
                'ÎÇ®ÏùÄÏûêÎ¶¨': isNaN(parseInt(selectedParking['available_spots'])) ? null : parseInt(selectedParking['available_spots']),
                'Î≥ÑÏ†êÌèâÍ∑†': parseFloat(selectedParking['average_rating']).toFixed(2),
                'Ï†ÑÏ≤¥ÏûêÎ¶¨': parseInt(selectedParking['capacity']),
                'ÌèâÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å': selectedParking['weekday_start'],
                'ÌèâÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å': selectedParking['weekday_end'],
                'ÌÜ†ÏöîÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å': selectedParking['saturday_start'],
                'ÌÜ†ÏöîÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å': selectedParking['saturday_end'],
                'Í≥µÌú¥ÏùºÏö¥ÏòÅÏãúÏûëÏãúÍ∞Å': selectedParking['holiday_start'],
                'Í≥µÌú¥ÏùºÏö¥ÏòÅÏ¢ÖÎ£åÏãúÍ∞Å': selectedParking['holiday_end'],
                'Ï†ÑÌôîÎ≤àÌò∏': selectedParking['phone']
            };

            if (selectedParking) {
                document.getElementById('menu_wrap').style.display = "none"; 
                showParkingDetail(selectedParking);
                map.setCenter(new kakao.maps.LatLng(selectedParking.ÏúÑÎèÑ, selectedParking.Í≤ΩÎèÑ));

                // Ï∞úÌïú Ï£ºÏ∞®Ïû• Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä Í∞ÄÏ†∏Ïò® ÌõÑ ÎßàÏª§ Ï∂îÍ∞Ä
                loadUserFavorites().then(() => {
                    var parkingLatLng = new kakao.maps.LatLng(selectedParking.ÏúÑÎèÑ, selectedParking.Í≤ΩÎèÑ);
                    if (favoriteParkingIds.includes(selectedParking.id)) {
                        addFavoriteMarker(parkingLatLng, 0, selectedParking.Ï£ºÏ∞®Ïû•Î™Ö, selectedParking.ÎÇ®ÏùÄÏûêÎ¶¨, selectedParking);
                    } else {
                        addDefaultMarker(parkingLatLng, 0, selectedParking.Ï£ºÏ∞®Ïû•Î™Ö, selectedParking.ÎÇ®ÏùÄÏûêÎ¶¨, selectedParking);
                    }
                });
            }
        };
        </script>
    {% endif %}    
        {% endblock %}